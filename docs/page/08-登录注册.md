# 登录注册页面

## 页面标识
- **页面名称**: Login & Register / 登录注册
- **触发方式**: 模态弹窗
- **调用位置**: 
  - 首页导航栏
  - 未登录访问受保护页面
- **认证机制**: JWT Token + 微信OAuth
- **页面类型**: 认证弹窗

---

## 页面目标
1. 提供便捷的登录注册流程
2. 支持多种登录方式
3. 保障账户安全
4. 优化用户体验

---

## 布局结构

### 登录弹窗
```
┌─────────────────────────────────────────┐
│  登录到 OneStory                     [×] │
├─────────────────────────────────────────┤
│                                         │
│       [Logo OneStory]                   │
│   AI驱动的视频故事板创作平台             │
│                                         │
│   ┌─────────────────────────────────┐   │
│   │ 手机号登录                       │   │
│   └─────────────────────────────────┘   │
│                                         │
│   手机号:                                │
│   ┌─────────────────────────────────┐   │
│   │ +86 [输入框]                     │   │
│   └─────────────────────────────────┘   │
│                                         │
│   验证码:                                │
│   ┌───────────────────┬─────────────┐   │
│   │ [输入框]          │ [获取验证码] │   │
│   └───────────────────┴─────────────┘   │
│                                         │
│   ┌─────────────────────────────────┐   │
│   │        登  录                    │   │
│   └─────────────────────────────────┘   │
│                                         │
│   ────────── 或 ──────────              │
│                                         │
│   ┌─────────────────────────────────┐   │
│   │ [微信图标] 微信扫码登录           │   │
│   └─────────────────────────────────┘   │
│                                         │
│   还没有账号? [立即注册]                 │
│                                         │
└─────────────────────────────────────────┘
```

---

## 组件详细设计

### 1. 弹窗容器

#### 尺寸规范
```css
宽度: 420px
高度: 自适应
背景: #FFFFFF
圆角: 16px
阴影: 0 8px 32px rgba(0,0,0,0.15)
内边距: 32px
z-index: 10000
```

#### 遮罩层
```css
背景: rgba(0,0,0,0.6)
模糊: backdrop-filter: blur(4px)
点击: 关闭弹窗
```

---

### 2. 弹窗头部

#### Logo和标题
```
[Logo]
尺寸: 64px × 64px
位置: 居中

标题:
  文本: "登录到 OneStory"
  字号: 24px
  字重: Bold
  颜色: #1A1A1A
  对齐: 居中
  
副标题:
  文本: "AI驱动的视频故事板创作平台"
  字号: 14px
  颜色: #667085
  对齐: 居中
```

#### 关闭按钮
```
位置: 右上角
图标: × 叉号
尺寸: 32px × 32px
颜色: #98A2B3
悬停: #667085
```

---

### 3. 登录方式切换

#### Tab切换栏
```
┌──────────────────────────────┐
│ [手机号登录] [邮箱登录]       │
└──────────────────────────────┘
```

样式:
```css
Tab按钮:
  高度: 40px
  内边距: 8px 16px
  字号: 14px
  
默认状态:
  背景: transparent
  文字: #667085
  
选中状态:
  背景: #F0F5FF
  文字: 主色
  底部边框: 2px solid 主色
```

---

### 4. 手机号登录表单

#### 手机号输入框

**布局**:
```
┌─────┬──────────────────────────┐
│ +86 │ [手机号输入框]            │
└─────┴──────────────────────────┘
```

**样式**:
```css
高度: 48px
边框: 1px solid #D0D5DD
圆角: 8px
内边距: 12px

区号选择器:
  宽度: 60px
  默认: +86
  可选: +86, +852, +853, +886
  
输入框:
  占位符: "请输入手机号"
  类型: tel
  最大长度: 11位
  
聚焦状态:
  边框: 2px solid 主色
```

**验证规则**:
```
格式: 11位数字
正则: /^1[3-9]\d{9}$/
实时验证: 输入时检查
错误提示: "请输入有效的手机号"
```

#### 验证码输入框

**布局**:
```
┌──────────────────┬──────────────┐
│ [验证码输入框]    │ [获取验证码]  │
└──────────────────┴──────────────┘
```

**验证码输入**:
```
占位符: "请输入验证码"
类型: text
最大长度: 6位
宽度: 60%
```

**获取验证码按钮**:
```
默认状态:
  文本: "获取验证码"
  类型: 次要按钮
  宽度: 38%
  
倒计时状态:
  文本: "60s后重新获取"
  禁用: true
  颜色: #98A2B3
  
可重新获取:
  文本: "重新获取"
  可点击: true
```

---

### 5. 验证码机制

#### 阿里云验证码集成

**滑动验证**:
```
1. 点击"获取验证码"
2. 弹出滑动验证框:
   ┌───────────────────────────┐
   │ 请拖动滑块完成拼图         │
   │                           │
   │ [拼图图片]                │
   │                           │
   │ [●━━━━━━━━━━━━━━━━━]      │
   │   向右拖动滑块             │
   └───────────────────────────┘
3. 验证成功后发送短信
```

**短信验证码**:
```
发送时机: 滑动验证成功后
发送内容: "您的验证码是123456，5分钟内有效"
有效期: 5分钟
限制: 同一手机号60秒内只能发送一次
```

---

### 6. 登录按钮

#### 按钮设计
```
文本: "登 录"
类型: 主要按钮
尺寸: 100% × 48px
背景: 主色渐变
文字: 白色，16px，Medium
圆角: 8px
阴影: 0 2px 8px rgba(主色,0.3)

禁用状态（未填写完整）:
  背景: #F2F4F7
  文字: #98A2B3
  
加载状态（登录中）:
  显示: 旋转加载图标
  文字: "登录中..."
```

---

### 7. 微信扫码登录

#### 扫码按钮
```
┌─────────────────────────────────┐
│ [微信图标] 微信扫码登录           │
└─────────────────────────────────┘
```

样式:
```css
高度: 48px
背景: #FFFFFF
边框: 1px solid #E4E7EC
圆角: 8px
颜色: #07C160（微信绿）
图标尺寸: 20px
```

#### 扫码弹窗
```
┌─────────────────────────────────┐
│ 微信扫码登录                  [×] │
├─────────────────────────────────┤
│                                 │
│   ┌───────────────────────┐     │
│   │                       │     │
│   │     [二维码图片]       │     │
│   │                       │     │
│   └───────────────────────┘     │
│                                 │
│   请使用微信扫描二维码登录        │
│                                 │
│   二维码 2 分钟内有效             │
│                                 │
│   [刷新二维码]                   │
│                                 │
└─────────────────────────────────┘
```

#### 扫码流程
```
1. 点击"微信扫码登录"
2. 请求二维码:
   GET /api/auth/wechat/qrcode
3. 显示二维码（open.weixin.qq.com）
4. 轮询扫码状态（每2秒）
5. 状态变化:
   - 未扫码: 显示二维码
   - 已扫码: "已扫码，请在手机上确认"
   - 已确认: 登录成功，关闭弹窗
   - 已过期: 显示"刷新二维码"按钮
```

---

### 8. 注册流程

#### 切换到注册
```
点击: "还没有账号? [立即注册]"
切换: 登录弹窗 → 注册弹窗
```

#### 注册弹窗
```
┌─────────────────────────────────────────┐
│  注册 OneStory账号                   [×] │
├─────────────────────────────────────────┤
│                                         │
│   手机号:                                │
│   ┌─────────────────────────────────┐   │
│   │ +86 [输入框]                     │   │
│   └─────────────────────────────────┘   │
│                                         │
│   验证码:                                │
│   ┌───────────────────┬─────────────┐   │
│   │ [输入框]          │ [获取验证码] │   │
│   └───────────────────┴─────────────┘   │
│                                         │
│   设置密码（可选）:                      │
│   ┌─────────────────────────────────┐   │
│   │ [密码输入框]                     │   │
│   └─────────────────────────────────┘   │
│                                         │
│   ☑ 我已阅读并同意《用户协议》和          │
│      《隐私政策》                        │
│                                         │
│   ┌─────────────────────────────────┐   │
│   │        注  册                    │   │
│   └─────────────────────────────────┘   │
│                                         │
│   已有账号? [立即登录]                   │
│                                         │
└─────────────────────────────────────────┘
```

#### 密码输入框
```
占位符: "设置登录密码（可选，建议设置）"
类型: password
验证规则:
  - 长度: 6-20位
  - 包含: 字母、数字
  - 强度指示器:
    ━━━━━━━━━━━━
    弱 中 强
```

#### 用户协议
```
☑ 我已阅读并同意《用户协议》和《隐私政策》

复选框:
  默认: 未勾选
  必选: 必须勾选才能注册
  
链接:
  点击: 打开新标签页查看协议内容
```

---

### 9. 登录成功处理

#### 成功流程
```
1. 后端返回JWT Token
2. 存储Token:
   - localStorage: token
   - Cookie: token (HttpOnly)
3. 获取用户信息:
   GET /api/user/info
4. 更新全局状态
5. 关闭登录弹窗
6. 跳转到:
   - 来源页面（如果有）
   - Dashboard（默认）
7. 显示欢迎提示:
   "欢迎回来，{用户名}！"
```

#### Token管理
```
存储位置:
  - localStorage: long-term storage
  - sessionStorage: 当前会话
  
有效期: 7天
刷新机制: 
  - 距离过期<24小时时自动刷新
  - 静默刷新，用户无感知
```

---

## API端点

### 发送验证码
```
端点: POST /api/auth/send_code
请求体:
{
  "phone": "13800138000",
  "type": "login" | "register",
  "captchaToken": "..." (阿里云验证码token)
}

响应:
{
  "code": 200,
  "message": "验证码已发送"
}
```

### 手机号登录
```
端点: POST /api/auth/login
请求体:
{
  "phone": "13800138000",
  "code": "123456"
}

响应:
{
  "code": 200,
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGci...",
    "userId": 123696,
    "expiresIn": 604800
  }
}
```

### 注册账号
```
端点: POST /api/auth/register
请求体:
{
  "phone": "13800138000",
  "code": "123456",
  "password": "abc123" (可选),
  "agree": true
}

响应:
{
  "code": 200,
  "data": {
    "token": "...",
    "userId": 123697
  }
}
```

### 微信登录
```
端点1: GET /api/auth/wechat/qrcode
响应:
{
  "code": 200,
  "data": {
    "qrcodeUrl": "https://open.weixin.qq.com/...",
    "ticket": "..."
  }
}

端点2: GET /api/auth/wechat/check?ticket={ticket}
响应:
{
  "code": 200,
  "data": {
    "status": "scanned" | "confirmed" | "expired",
    "token": "..." (confirmed时返回)
  }
}
```

---

## 错误处理

### 常见错误提示

**手机号错误**:
```
提示: "请输入有效的手机号"
位置: 输入框下方
颜色: #F04438（红色）
```

**验证码错误**:
```
提示: "验证码错误或已过期"
操作: 可重新获取验证码
```

**手机号已注册**（注册时）:
```
提示: "该手机号已注册，请直接登录"
操作: 
  - 显示"去登录"链接
  - 自动切换到登录Tab
```

**网络错误**:
```
提示: "网络连接失败，请检查网络后重试"
操作: 
  - 显示重试按钮
  - 保留已填写的信息
```

---

## 安全措施

### 防暴力破解
```
限制:
  - 同一手机号5次失败后锁定30分钟
  - 同一IP 10次失败后需要图形验证码
  - 验证码5分钟有效
```

### 敏感信息保护
```
Token传输: HTTPS加密
Token存储: HttpOnly Cookie
密码传输: 前端SHA256加密
密码存储: 后端Bcrypt加密
```

### 会话管理
```
单设备登录: 可选（默认允许多设备）
强制下线: 检测到异常时踢出
自动登出: 7天无操作自动退出
```

---

## 数据埋点

```javascript
// 打开登录弹窗
Amplitude.track('login_dialog_opened', {
  source: 'nav_bar' / 'auth_required'
})

// 切换登录方式
Amplitude.track('login_method_changed', {
  from: 'phone',
  to: 'wechat'
})

// 发送验证码
Amplitude.track('verification_code_sent', {
  phone: '138****8000',
  type: 'login'
})

// 登录成功
Amplitude.track('user_logged_in', {
  method: 'phone' / 'wechat',
  user_id: 123696,
  new_user: false
})

// 注册成功
Amplitude.track('user_registered', {
  method: 'phone',
  user_id: 123697
})
```

---

## 第三方集成

### 阿里云验证码
```javascript
// 加载验证码SDK
<script src="https://o.alicdn.com/captcha-frontend/aliyunCaptcha/AliyunCaptcha.js"></script>

// 初始化
AliyunCaptcha.init({
  scene: 'nc_login',
  element: '#captcha-element',
  success: function(data) {
    // 获取验证token
    sendVerificationCode(data.sessionId);
  }
});
```

### 微信OAuth
```
跳转URL:
https://open.weixin.qq.com/connect/qrconnect?
  appid=wxXXXXXXXXXX
  &redirect_uri=https://onestory.art/auth/callback
  &response_type=code
  &scope=snsapi_login
  &state=STATE
```

---

## 响应式设计

### 桌面端（>768px）
- 弹窗宽度: 420px
- 完整功能

### 移动端（<768px）
- 全屏显示
- 弹窗宽度: 100vw
- 简化布局
- 自动弹出键盘
- 原生输入体验

---

## 相关页面
- [首页](./01-首页.md)
- [Dashboard](./02-Dashboard.md)
- [个人设置](./09-个人设置.md)
