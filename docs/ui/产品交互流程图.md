# OneStory 产品交互流程图

## 一、整体用户旅程流程

```mermaid
graph TD
    A[访问 onestory.art] --> B{用户是否登录?}
    B -->|否| C[展示首页 Landing Page]
    B -->|是| D[进入 Dashboard]
    
    C --> E[查看产品展示视频]
    C --> F[浏览案例模板]
    C --> G[点击登录/注册]
    
    G --> H{选择登录方式}
    H -->|微信扫码| I[微信授权登录]
    H -->|账号密码| J[输入凭证 + 验证码]
    
    I --> K[JWT Token认证]
    J --> K
    
    K --> L{认证成功?}
    L -->|是| D
    L -->|否| M[显示错误信息]
    M --> G
    
    D --> N[查看项目列表]
    D --> O[浏览模板库]
    D --> P[查看收益统计]
    D --> Q[创建新项目]
    
    N --> R{选择项目操作}
    R -->|编辑| S[进入故事板编辑器]
    R -->|复制| T[创建项目副本]
    R -->|删除| U[删除项目]
    
    O --> V[选择模板]
    V --> W[使用模板创建项目]
    W --> S
    
    Q --> S
    
    S --> X[TableView 编辑模式]
    X --> Y[添加/编辑镜头]
    X --> Z[批量AI生成图像]
    X --> AA[调整镜头顺序]
    X --> AB[设置时长和角色]
    
    Y --> AC[输入场景描述]
    AC --> Z
    
    Z --> AD[调用 batch_txt2img API]
    AD --> AE[轮询生成状态]
    AE --> AF{生成完成?}
    AF -->|否| AE
    AF -->|是| AG[更新预览图]
    
    AG --> AH[自动保存项目]
    AH --> AI{用户操作}
    
    AI -->|继续编辑| Y
    AI -->|预览视频| AJ[打开视频播放器]
    AI -->|导出| AK[下载/分享视频]
    AI -->|返回| D
    
    AJ --> AL[播放合成视频]
    AL --> AM{用户操作}
    AM -->|下载| AK
    AM -->|分享| AN[分享到社交平台]
    AM -->|关闭| X
```

## 二、核心功能子流程

### 2.1 用户认证流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant A as API服务器
    participant W as 微信开放平台
    participant AC as 阿里云验证码

    U->>F: 访问首页
    F->>U: 展示登录界面
    
    alt 微信登录
        U->>F: 点击微信登录
        F->>W: 跳转微信授权页面
        W->>U: 展示二维码
        U->>W: 扫码授权
        W->>F: 返回授权码
        F->>A: POST /api/user/wechat_login
        A->>A: 验证授权码
        A->>F: 返回 JWT Token
    else 账号密码登录
        U->>F: 输入账号密码
        F->>AC: 加载验证码组件
        AC->>F: 展示验证码
        U->>F: 完成验证码
        F->>A: POST /api/user/login (含验证码)
        A->>A: 验证凭证
        A->>F: 返回 JWT Token
    end
    
    F->>F: 存储 Token 到 LocalStorage
    F->>A: GET /api/user/info (Header: Bearer Token)
    A->>F: 返回用户信息
    F->>U: 跳转到 Dashboard
```

### 2.2 项目管理流程

```mermaid
graph TD
    A[Dashboard] --> B[获取项目列表]
    B --> C[GET /api/storyboard/project/list]
    C --> D{有项目数据?}
    
    D -->|是| E[展示项目卡片]
    D -->|否| F[显示空状态]
    
    E --> G{用户操作}
    F --> H[点击创建第一个项目]
    
    G -->|创建新项目| H
    G -->|编辑项目| I[GET /api/storyboard/project?id=xxx]
    G -->|复制项目| J[POST /api/storyboard/project/copy]
    G -->|删除项目| K[DELETE /api/storyboard/project]
    
    H --> L[创建空白项目记录]
    I --> M[加载项目详情]
    
    M --> N[进入 TableView 编辑器]
    L --> N
    
    J --> O[创建项目副本]
    O --> E
    
    K --> P[确认删除]
    P --> Q[刷新项目列表]
    Q --> B
```

### 2.3 故事板编辑与AI生成流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant E as 编辑器
    participant A as API服务器
    participant AI as AI图像生成服务
    participant OSS as 阿里云OSS

    U->>E: 打开项目编辑器
    E->>A: GET /api/storyboard/fetch_shot
    A->>E: 返回镜头列表数据
    E->>U: 展示 TableView
    
    U->>E: 添加新镜头
    E->>E: 插入空行
    
    U->>E: 输入场景描述
    U->>E: 设置角色和时长
    E->>E: 自动保存到 LocalStorage
    
    U->>E: 选择多个镜头
    U->>E: 点击"AI批量生成"
    
    E->>A: POST /api/storyboard/batch_txt2img
    Note over E,A: 请求体包含: projectId, shots[]
    A->>AI: 调用图像生成模型
    AI->>AI: 处理文本描述
    A->>E: 返回任务ID
    
    E->>E: 启动 Worker 轮询
    
    loop 每2秒轮询一次
        E->>A: GET /api/storyboard/generation_status?taskId=xxx
        A->>E: 返回进度 (0-100%)
        E->>U: 更新进度条
    end
    
    AI->>OSS: 上传生成的图片
    OSS->>OSS: 存储到 generate_storyboard_images/
    
    A->>A: 标记生成完成
    E->>A: GET /api/storyboard/fetch_shot (最后一次轮询)
    A->>E: 返回包含图片URL的镜头数据
    
    E->>OSS: 加载预览图
    OSS->>E: 返回图片 (带质量压缩参数)
    E->>U: 展示生成结果
    
    E->>A: POST /api/storyboard/save (自动保存)
    A->>E: 保存成功
```

### 2.4 视频预览与导出流程

```mermaid
graph TD
    A[编辑器] --> B[点击预览按钮]
    B --> C[POST /api/storyboard/generate_video]
    C --> D[后台视频合成]
    
    D --> E[合成镜头图片]
    E --> F[添加过渡效果]
    F --> G[渲染音轨可选]
    G --> H[上传到 OSS converted_videos/]
    
    H --> I[返回视频URL]
    I --> J[打开视频播放器模态框]
    
    J --> K[FilePlayer组件加载]
    K --> L[Range请求分段加载]
    L --> M{视频加载成功?}
    
    M -->|是| N[展示播放控件]
    M -->|否| O[显示错误提示]
    
    N --> P{用户操作}
    P -->|播放/暂停| Q[控制视频播放]
    P -->|调整进度| R[拖拽进度条]
    P -->|调整音量| S[音量滑块]
    P -->|全屏| T[进入全屏模式]
    P -->|下载| U[触发文件下载]
    P -->|分享| V[复制分享链接]
    
    U --> W[从OSS下载原视频]
    V --> X[调用分享API]
    X --> Y[分享到TikTok/Bilibili]
```

## 三、状态管理流程

### 3.1 数据持久化策略

```mermaid
graph LR
    A[用户操作] --> B{操作类型}
    
    B -->|输入文本| C[LocalStorage暂存]
    B -->|生成图片| D[云端保存]
    B -->|点击保存| E[立即同步]
    
    C --> F{3秒后}
    F --> G[自动保存到服务器]
    
    D --> H[调用 API保存]
    E --> H
    G --> H
    
    H --> I[更新服务器数据]
    I --> J[返回保存状态]
    
    J --> K{成功?}
    K -->|是| L[显示成功提示]
    K -->|否| M[保留本地数据]
    
    M --> N[等待网络恢复]
    N --> O[重试保存]
```

### 3.2 消息通知流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant A as API服务器
    participant M as 消息系统

    F->>A: GET /api/user/message/unread
    A->>F: 返回未读消息数
    F->>F: 更新消息角标
    
    alt 有弹窗消息
        A->>F: GET /api/user/message/popup
        F->>U: 展示弹窗消息
        U->>F: 点击查看/关闭
        F->>A: POST /api/user/message/read
    end
    
    loop 每30秒轮询
        F->>A: GET /api/user/message/unread
        A->>F: 返回最新未读数
    end
    
    M->>A: 系统生成新消息
    A->>F: 下次轮询时返回
    F->>U: 更新消息提醒
```

## 四、错误处理流程

### 4.1 API错误处理

```mermaid
graph TD
    A[发起API请求] --> B{请求成功?}
    
    B -->|是| C[解析响应数据]
    B -->|否| D{错误类型}
    
    D -->|401未授权| E[清除Token]
    D -->|403禁止访问| F[显示权限不足]
    D -->|404未找到| G[显示资源不存在]
    D -->|500服务器错误| H[显示服务器错误]
    D -->|网络超时| I[显示超时提示]
    
    E --> J[跳转到登录页]
    F --> K[提示联系管理员]
    G --> L[返回上一页]
    H --> M[提供重试按钮]
    I --> M
    
    M --> N{用户点击重试}
    N -->|是| A
    N -->|否| O[保持当前状态]
    
    C --> P{业务逻辑校验}
    P -->|成功| Q[更新UI]
    P -->|失败| R[显示业务错误]
```

### 4.2 AI生成失败处理

```mermaid
graph TD
    A[AI生成任务] --> B[轮询状态]
    B --> C{生成结果}
    
    C -->|成功| D[更新预览图]
    C -->|失败| E{失败原因}
    
    E -->|内容审核未通过| F[提示修改描述]
    E -->|生成超时| G[提供重新生成]
    E -->|配额不足| H[提示充值]
    E -->|服务异常| I[联系客服]
    
    F --> J[高亮问题镜头]
    G --> K[重新提交任务]
    H --> L[跳转充值页面]
    I --> M[显示工单入口]
    
    K --> A
```

## 五、数据分析埋点流程

### 5.1 用户行为追踪

```mermaid
graph LR
    A[用户操作] --> B{事件类型}
    
    B -->|页面浏览| C[Amplitude: Page Viewed]
    B -->|功能入口展示| D[字节统计: function_entrance_show]
    B -->|AI功能调用| E[字节统计: image_ai_function_entrance_show]
    
    C --> F[收集页面信息]
    D --> G[收集功能模块信息]
    E --> H[收集AI调用参数]
    
    F --> I[发送到 api2.amplitude.com]
    G --> J[发送到 mcs.zijieapi.com]
    H --> J
    
    I --> K[Amplitude后台分析]
    J --> L[字节统计后台]
    
    K --> M[生成用户画像]
    L --> N[生成功能使用报告]
```

## 六、页面路由结构

```mermaid
graph TD
    A[/ 根路径] --> B[/dashboard Dashboard主页]
    A --> C[/login 登录页]
    A --> D[/showcase 案例展示]
    
    B --> E[/dashboard/projects 项目列表]
    B --> F[/dashboard/templates 模板库]
    B --> G[/dashboard/benefit 收益统计]
    B --> H[/dashboard/settings 设置]
    
    E --> I[/dashboard/:projectId/tableView 编辑器]
    F --> J[/dashboard/template/:templateId 模板详情]
    
    I --> K[模态窗口: 视频预览]
    I --> L[模态窗口: 角色编辑]
    I --> M[模态窗口: AI生成进度]
```

## 七、技术流程图

### 7.1 前端资源加载流程

```mermaid
graph TD
    A[用户访问] --> B[加载 index.html]
    B --> C[解析 HTML]
    C --> D[下载 index-CKrN9dCp.js]
    C --> E[下载 index-BqYiNvCQ.css]
    
    D --> F[初始化 SPA应用]
    E --> G[应用全局样式]
    
    F --> H[路由匹配]
    H --> I{需要认证?}
    
    I -->|是| J{Token有效?}
    I -->|否| K[加载公开页面]
    
    J -->|是| L[加载用户页面]
    J -->|否| M[重定向登录]
    
    L --> N[按需加载组件]
    N --> O[FilePlayer组件]
    N --> P[TableView组件]
    
    O --> Q[加载播放器资源]
    P --> R[加载编辑器资源]
    
    Q --> S[启动应用]
    R --> S
    K --> S
```

### 7.2 CDN资源分发流程

```mermaid
graph LR
    A[用户请求资源] --> B{资源类型}
    
    B -->|静态资源| C[static.chuangyi-keji.com]
    B -->|API请求| D[onestory.art/api]
    
    C --> E{文件类型}
    E -->|视频| F[converted_videos/]
    E -->|图片| G[generate_storyboard_images/]
    E -->|通用资源| H[common/]
    
    F --> I[阿里云OSS]
    G --> I
    H --> I
    
    I --> J[CDN边缘节点]
    J --> K[返回给用户]
    
    D --> L[API网关]
    L --> M[后端服务集群]
    M --> N[返回JSON数据]
```

## 八、移动端适配流程（未来规划）

```mermaid
graph TD
    A[检测设备类型] --> B{屏幕宽度}
    
    B -->|< 768px| C[移动端布局]
    B -->|≥ 768px| D[桌面端布局]
    
    C --> E[汉堡菜单]
    C --> F[卡片式故事板]
    C --> G[全屏视频播放]
    
    D --> H[侧边栏导航]
    D --> I[表格式故事板]
    D --> J[弹窗视频播放]
    
    E --> K[Touch事件优化]
    F --> K
    G --> K
    
    H --> L[鼠标事件]
    I --> L
    J --> L
```

---

**流程图说明**:
- 以上流程图使用 Mermaid 语法编写
- 可在支持 Mermaid 的 Markdown 渲染器中查看图形化展示
- 涵盖了 OneStory 平台的核心业务流程、技术架构流程和交互细节

**更新日期**: 2025-10-24
